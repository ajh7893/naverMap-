<!DOCTYPE html>

<html lang="ko" class="">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ê²½ê¸°ë„ ë¬¼ì •ë³´ì‹œìŠ¤í…œ</title>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="description" content="ê²½ê¸°ë„ ìš°ë¦¬ì§‘ ìˆ˜ë—ë¬¼, ì•ˆì‹¬ ë¬¼ë†€ì´ ì‹œì„¤, ìš°ë¦¬ë™ë„¤ ì•½ìˆ˜í„°, ì•„ë¦„ë‹¤ìš´ ë¬¼ê¸¸, ìˆ˜ì§ˆ, ìˆ˜ëŸ‰, ê¸°ìƒ, í†µê³„ ì œê³µ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

    <link rel="shortcut icon" href="/common/images/favicon.ico" type="image/x-icon">

    <!-- common -->
    <!-- ë„¤ì´ë²„ ì§€ë„ api  -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?govClientId=tzo0erifbf"></script>
    <link rel="stylesheet" type="text/css" href="/common/plugin/bootstrap/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/common/css/default.css">
    <link rel="stylesheet" type="text/css" href="/common/css/map.css">
    <script src="/common/js/jquery-1.12.4.min.js"></script>
    <script src="/common/js/jquery-ui.js"></script>

    <!-- design -->
    <link rel="stylesheet" type="text/css" href="/common/css/theme.css">

</head>

<body>

<div id="mapService">
    <!-- í•„í„° -->
    <div id="mapControlBox">
        <div class="location_group">
            <button class="btn_location" type="button">
                <div></div>
            </button>

            <div>
                <select class="mapSelect" onchange="moveToLocation(this.value)">
                    <option value="all">ì „ì²´</option>
                    <option value="ìˆ˜ì›ì‹œ">ìˆ˜ì›ì‹œ</option>
                    <option value="ìš©ì¸ì‹œ">ìš©ì¸ì‹œ</option>
                    <option value="ê³ ì–‘ì‹œ">ê³ ì–‘ì‹œ</option>
                    <option value="í™”ì„±ì‹œ">í™”ì„±ì‹œ</option>
                    <option value="ì„±ë‚¨ì‹œ">ì„±ë‚¨ì‹œ</option>
                    <option value="ë¶€ì²œì‹œ">ë¶€ì²œì‹œ</option>
                    <option value="ë‚¨ì–‘ì£¼ì‹œ">ë‚¨ì–‘ì£¼ì‹œ</option>
                    <option value="ì•ˆì‚°ì‹œ">ì•ˆì‚°ì‹œ</option>
                    <option value="í‰íƒì‹œ">í‰íƒì‹œ</option>
                    <option value="ì•ˆì–‘ì‹œ">ì•ˆì–‘ì‹œ</option>
                    <option value="ì‹œí¥ì‹œ">ì‹œí¥ì‹œ</option>
                    <option value="íŒŒì£¼ì‹œ">íŒŒì£¼ì‹œ</option>
                    <option value="ê¹€í¬ì‹œ">ê¹€í¬ì‹œ</option>
                    <option value="ì˜ì •ë¶€ì‹œ">ì˜ì •ë¶€ì‹œ</option>
                    <option value="ê´‘ì£¼ì‹œ">ê´‘ì£¼ì‹œ</option>
                    <option value="í•˜ë‚¨ì‹œ">í•˜ë‚¨ì‹œ</option>
                    <option value="ê´‘ëª…ì‹œ">ê´‘ëª…ì‹œ</option>
                    <option value="êµ°í¬ì‹œ">êµ°í¬ì‹œ</option>
                    <option value="ì–‘ì£¼ì‹œ">ì–‘ì£¼ì‹œ</option>
                    <option value="ì˜¤ì‚°ì‹œ">ì˜¤ì‚°ì‹œ</option>
                    <option value="ì´ì²œì‹œ">ì´ì²œì‹œ</option>
                    <option value="ì•ˆì„±ì‹œ">ì•ˆì„±ì‹œ</option>
                    <option value="êµ¬ë¦¬ì‹œ">êµ¬ë¦¬ì‹œ</option>
                    <option value="ì˜ì™•ì‹œ">ì˜ì™•ì‹œ</option>
                    <option value="í¬ì²œì‹œ">í¬ì²œì‹œ</option>
                    <option value="ì–‘í‰êµ°">ì–‘í‰êµ°</option>
                    <option value="ì—¬ì£¼ì‹œ">ì—¬ì£¼ì‹œ</option>
                    <option value="ë™ë‘ì²œì‹œ">ë™ë‘ì²œì‹œ</option>
                    <option value="ê³¼ì²œì‹œ">ê³¼ì²œì‹œ</option>
                    <option value="ê°€í‰êµ°">ê°€í‰êµ°</option>
                    <option value="ì—°ì²œêµ°">ì—°ì²œêµ°</option>
                </select>
            </div>
        </div>

        <div class="filter_group">
            <a href="#!" class="filter_m_btn"><span></span></a>
            <ul class="">
                <li class="flt_all">
                    <button type="button" id="selectAll">ì „ì²´</button>
                </li>
                <li class="flt_1"><!--ì„ íƒë˜ë©´ .check ë¶™ì–´ì•¼í•¨-->
                    <button type="button" id="MNSP">ì•½ìˆ˜í„°</button>
                </li>
                <li class="flt_2">
                    <button type="button" onclick="drawWATERFCLTSLayer('FOUNTAIN')">ë¶„ìˆ˜ì‹œì„¤</button>
                </li>
                <li class="flt_3">
                    <button type="button" onclick="drawWATERFCLTSLayer('MOORAGE')">ê³„ë¥˜ì‹œì„¤</button>
                </li>
                <li class="flt_4">
                    <button type="button" onclick="drawWATERFCLTSLayer('WATERFLOW')">ë²½ì²œ</button>
                </li>
                <li class="flt_5">
                    <button type="button" onclick="drawWATERFCLTSLayer('COMBINATION')">ì¡°í•©ë†€ì´ëŒ€</button>
                </li>

<!--                <li class="flt_6">-->
<!--                    <button type="button" id="tt">ë¬¼ë†€ì´ì¥</button>-->
<!--                </li>-->
                <li class="flt_7 noIco">
                    <button type="button" id="ECRIV">ìƒíƒœí•˜ì²œ</button>
                </li>
                <li class="flt_8 noIco">
                    <button type="button" id="RIVER_NATION">êµ­ê°€í•˜ì²œ</button>
                </li>
                <li class="flt_9 noIco">
                    <button type="button" id="RIVER_PROVINCE">ì§€ë°©í•˜ì²œ</button>
                </li>
            </ul>
        </div>
    </div>
    <script>
        $('.filter_m_btn').click(function () {
            $('.filter_group > ul').toggleClass('active');
        });

        $('.filter_group ul li button').on('click', function () {
            $(this).parent().toggleClass('check'); // check í´ë˜ìŠ¤ í† ê¸€
        });
    </script>

    <!-- ì§€ë„ ë§ˆì»¤ -->
    <!--<div class="map_marker">
        <div class="point_img flt_1"></div>
    </div>-->

    <!-- ì§€ë„ ë§ˆì»¤ ì¥ì†Œëª… -->
    <!--<div class="map_marker_title">
        <span>í•œë§ˆìŒ ì•½ìˆ˜í„°</span>
    </div>-->

    <!-- íŒì—…1 : ì•½ìˆ˜í„°ë§Œ ì‚¬ìš© -->
    <!--<div class="mapPopUp" style="top:20%;left:20%;">
        <div class="place_title">
            <div class="flt_icon flt_1">ì•½ìˆ˜í„°</div>
            <span class="able">ìŒìš©ê°€ëŠ¥</span>
            <a href="#!" class="btn_close"></a>
        </div>
        <div class="place_con">
            <div class="img" style="background-image: url('/common/images/sample_img.jpg');"></div>
            <div>
                <p class="place_name">í•œë§ˆìŒ ì•½ìˆ˜í„°</p>
                <ul class="place_info">
                    <li>ê²€ì‚¬ì¼ : <span>2024-11-30</span></li>
                    <li>ì£¼ì†Œ : <span>ê´‘ëª…ì‹œ 00êµ¬ 00ë™ 11ë²ˆì§€</span></li>
                    <li>ë‹´ë‹¹ë¶€ì„œ : <span>ê´‘ëª…ì‹œ ìˆ˜ì§ˆí™˜ê²½ê³¼</span></li>
                    <li>ì—°ë½ì²˜ : <span>1234-1234-5678</span></li>
                </ul>
            </div>
        </div>
    </div>-->

    <!-- íŒì—…2 : ì•½ìˆ˜í„° ì œì™¸ ë‚˜ë¨¸ì§€ ì‹œì„¤ ì‚¬ìš© -->
    <!--<div class="mapPopUp" style="top:20%;left:60%;">
        <div class="place_title">
            <div class="flt_icon flt_2">ë¶„ìˆ˜ì‹œì„¤</div>
            <span class="disable">ìš´ì˜ì¤‘ë‹¨</span>
            <a href="#!" class="btn_close"></a>
        </div>
        <div class="place_con">
            <div class="img" style="background-image: url('/common/images/sample_img.jpg');"></div>
            <div>
                <p class="place_name">00ê³µì› ë°”ë‹¥ë¶„ìˆ˜</p>
                <ul class="place_info">
                    <li>ì ê²€ì¼ : <span>2023-01-27</span></li>
                    <li>ì£¼ì†Œ : <span>ê´‘ëª…ì‹œ 00êµ¬ 00ë™ 31ë²ˆì§€</span></li>
                    <li>ë‹´ë‹¹ë¶€ì„œ : <span>ê´‘ëª…ì‹œ ìˆ˜ì§ˆí™˜ê²½ê³¼</span></li>
                    <li>ì—°ë½ì²˜ : <span>1234-1234-5678</span></li>
                </ul>
            </div>
        </div>
    </div>-->

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="sampleMap" class="map"></div>

</div>
</body>
<script>

    var map; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ì„¤ì •

    var isRiverNationVisivle = false; // GeoJSON í‘œì‹œ ì—¬ë¶€ í™•ì¸ìš© ë³€ìˆ˜
    var riverNationLayer; // êµ­ê°€í•˜ì²œ ë ˆì´ì–´ ì €ì¥ ë³€ìˆ˜

    var isEcrivVisible = false; // ìƒíƒœí•˜ì²œ ë ˆì´ì–´ í‘œì‹œ ì—¬ë¶€ ë³€ìˆ˜
    var ecrivLayer; // ìƒíƒœí•˜ì²œ ë ˆì´ì–´ ì €ì¥ ë³€ìˆ˜

    var isRiverProvinceVisivle =false;  // ì§€ë°©í•˜ì²œ ë ˆì´ì–´ í‘œì‹œ ì—¬ë¶€ ë³€ìˆ˜
    var riverProvinceLayer; // ì§€ë°©í•˜ì²œ ë ˆì´ì–´ ì €ì¥ ë³€ìˆ˜

    var url = 'http://localhost'
    var path = '/data/'

    // ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    function getCurrentLocation() {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                let latitude = position.coords.latitude; // ìœ„ë„
                let longitude = position.coords.longitude; // ê²½ë„

                //console.log(`í˜„ì¬ ìœ„ì¹˜ - ìœ„ë„: ${latitude}, ê²½ë„: ${longitude}`);

                // ì§€ë„ ì´ë™
                moveToCurrentLocation(latitude, longitude);
            },
            (error) => {
                console.error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        );
    }

    // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    function initMap(lat, lng) {
        map = new naver.maps.Map('sampleMap', {
            zoom: 16,
            center: new naver.maps.LatLng(lat, lng)
        });
    }

    // ì§€ë„ ì¤‘ì‹¬ ì´ë™ í•¨ìˆ˜
    function moveToCurrentLocation(lat, lng) {
        if (map) {
            var newCenter = new naver.maps.LatLng(lat, lng);
            map.setCenter(newCenter);
            //console.log("ì§€ë„ê°€ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.");
        } else {
            console.error("ì§€ë„ ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }

    function drowEcriv() {
        var param = 'works_ECRIV.json';

        if (isEcrivVisible) {
            // ë ˆì´ì–´ê°€ ì´ë¯¸ ì¶”ê°€ëœ ê²½ìš° ì‚­ì œ
            clearEcriv();
            isEcrivVisible = false;
        } else {
            // GeoJSON ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì§€ë„ì— ì¶”ê°€
            $.ajax({
                url: url + path + param, //https://water.gg.go.kr/geoserver/GWMS_works/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=GWMS_works:ECRIV&outputFormat=application/json&SRSNAME=EPSG:4326
                dataType: 'json',
                success: function (geojson) {
                    ecrivLayer = new naver.maps.Data();
                    ecrivLayer.addGeoJson(geojson);
                    ecrivLayer.setMap(map); // ì§€ë„ì— ì¶”ê°€

                    ecrivLayer.setStyle(function (feature) {
                        var color = 'green'; // ê¸°ë³¸ ìƒ‰ìƒ
                        if (feature.getProperty('isColorful')) {
                            color = feature.getProperty('color');
                        }

                        return {
                            fillColor: color,
                            strokeColor: color,
                            strokeWeight: 5
                        };
                    });

                    isEcrivVisible = true; // ìƒíƒœ ì—…ë°ì´íŠ¸
                }
            });
        }
    }

    // ì§€ë„ì—ì„œ ìƒíƒœí•˜ì²œ ë ˆì´ì–´ ì œê±°
    function clearEcriv() {
        if (ecrivLayer) {
            ecrivLayer.setMap(null); // ì§€ë„ì—ì„œ ì œê±°
            ecrivLayer = null; // ë©”ëª¨ë¦¬ ì •ë¦¬
        }
    }

    //êµ­ê°€ í•˜ì²œ ê·¸ë¦¬ê¸°
    function drowRiverNation() {
        var param = 'works_RIVER_NATION.json';

        if (isRiverNationVisivle) {
            // ì´ë¯¸ ì¶”ê°€ëœ ë ˆì´ì–´ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            clearRiverNation();
            isRiverNationVisivle = false;
        } else {
            // GeoJSON ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì§€ë„ì— ì¶”ê°€
            $.ajax({
                url: url + path + param,  //https://water.gg.go.kr/geoserver/GWMS_works/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=GWMS_works:RIVER_NATION&outputFormat=application/json&SRSNAME=EPSG:4326
                dataType: 'json',
                success: function (geojson) {
                    riverNationLayer = new naver.maps.Data();
                    riverNationLayer.addGeoJson(geojson);
                    //console.log(geojson);
                    riverNationLayer.setMap(map); // ì§€ë„ì— ì¶”ê°€

                    riverNationLayer.setStyle(function (feature) {
                        var color = 'blue';
                        if (feature.getProperty('isColorful')) {
                            color = feature.getProperty('color');
                        }

                        return {
                            fillColor: 'black',
                            strokeColor: color,
                            fillWeight: 5,
                            strokeWeight: 5
                        };
                    });

                    isRiverNationVisivle = true; // ìƒíƒœ ì—…ë°ì´íŠ¸
                }
            });
        }
    }

    // ì§€ë„ì—ì„œ êµ­ê°€í•˜ì²œ ë ˆì´ì–´ ì œê±°
    function clearRiverNation() {
        if (riverNationLayer) {
            riverNationLayer.setMap(null); // ì§€ë„ì—ì„œ ì œê±°
            riverNationLayer = null; // ë©”ëª¨ë¦¬ ì •ë¦¬
        }
    }

    //ì§€ë°©í•˜ì²œ
    function drowRiverProvince() {
        var param = 'works_RIVER_PROVINCE.json';
        if (isRiverProvinceVisivle) {
            // ì´ë¯¸ ì¶”ê°€ëœ ë ˆì´ì–´ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            clearRiverProvince();
            isRiverProvinceVisivle = false;
        } else {
            // GeoJSON ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì§€ë„ì— ì¶”ê°€
            $.ajax({
                url: url + path + param, //https://water.gg.go.kr/geoserver/GWMS_works/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=GWMS_works:RIVER_PROVINCE&outputFormat=application/json&SRSNAME=EPSG:4326
                dataType: 'json',
                success: function (geojson) {
                    riverProvinceLayer = new naver.maps.Data();
                    riverProvinceLayer.addGeoJson(geojson);
                    //console.log(geojson);
                    riverProvinceLayer.setMap(map); // ì§€ë„ì— ì¶”ê°€

                    riverProvinceLayer.setStyle(function (feature) {
                        var color = 'red';
                        if (feature.getProperty('isColorful')) {
                            color = feature.getProperty('color');
                        }

                        return {
                            fillColor: color,
                            strokeColor: color,
                            strokeWeight: 5
                        };
                    });

                    isRiverProvinceVisivle = true; // ìƒíƒœ ì—…ë°ì´íŠ¸
                }
            });
        }
    }

    // ì§€ë„ì—ì„œ êµ­ê°€í•˜ì²œ ë ˆì´ì–´ ì œê±°
    function clearRiverProvince() {
        if (riverProvinceLayer) {
            riverProvinceLayer.setMap(null); // ì§€ë„ì—ì„œ ì œê±°
            riverProvinceLayer = null; // ë©”ëª¨ë¦¬ ì •ë¦¬
        }
    }

    // ë°ì´í„° ë ˆì´ì–´ ì‚­ì œ í•¨ìˆ˜
    function removeAllDataLayer() {
        map.data.setMap(null);
        map.data = new naver.maps.Data();
        map.data.setMap(map);
    }


    // ì´ˆê¸° ì§€ë„ ì„¤ì • (ë‚´ìœ„ì¹˜ ê¸°ì¤€)
    navigator.geolocation.getCurrentPosition(
        (position) => {
            let latitude = position.coords.latitude; // ìœ„ë„
            let longitude = position.coords.longitude; // ê²½ë„
            console.log('ì´ˆê¸°í™”');
            // ì§€ë„ ì´ë™
            initMap(latitude, longitude);
        },
        (error) => {
            console.error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
            alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    );

    // Web Mercator (EPSG:3857) â†’ WGS84 (EPSG:4326) ë³€í™˜ í•¨ìˆ˜
    function webMercatorToWGS84(x, y) {
        var R = 6378137;

        var lon = (x / R) * (180 / Math.PI);
        var lat = (y / R) * (180 / Math.PI);
        lat = (180 / Math.PI) * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);

        return { lat, lon };
    }


    // ë§ˆì»¤ ë°°ì—´ (í˜„ì¬ ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ì €ì¥)
    var markerList = [];
    // ë²„íŠ¼ ìƒíƒœ ì €ì¥ (ì´ˆê¸° ìƒíƒœ: false)
    var isLayerActive = false;      // ì•½ìˆ˜í„° ìƒíƒœ
    var isAllSelected = false;      // ì „ì²´ ì„ íƒ ìƒíƒœ


    var currentInfoWindow ; // í˜„ì¬ ì—´ë¦° InfoWindowë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜

    function closeInfoWindow() {
        console.log('close')
        console.log(currentInfoWindow)
        if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null; // ë³€ìˆ˜ ì´ˆê¸°í™”
        }
    }
    // ì•½ìˆ˜í„° ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ ì¢Œí‘œ ë³€í™˜ ì ìš©
    function drawMNSPLayer() {
        var sigunNm = $(".mapSelect").val();
        if (sigunNm == "all") {
            sigunNm = '';
        }

        var param = 'ctzn_excelList_sigunNm_' + sigunNm + '.json';

        $.ajax({
            url: url + path + param,  //https://water.gg.go.kr/ctzn/excelList.do?sigunNm=%EC%88%98%EC%9B%90%EC%8B%9C ìˆ˜ì›ì‹œ
            dataType: 'json',
            data: { sigunNm: '' },
            success: function (geojson) {
                console.log("ì›ë³¸ ë°ì´í„°:", geojson);

                // **ê¸°ì¡´ ë§ˆì»¤ ì œê±°**
                clearMarkers();

                // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ ë§µ ìƒì„±
                var uniqueDataMap = new Map();

                // ì¢Œí‘œ ë³€í™˜ ì ìš© ë° ì¤‘ë³µ ì œê±°
                geojson.forEach(item => {
                    if (!uniqueDataMap.has(item.fcltyNm)) {
                        var converted = webMercatorToWGS84(parseFloat(item.x), parseFloat(item.y));
                        uniqueDataMap.set(item.fcltyNm, {
                            ...item,
                            latitude: converted.lat,
                            longitude: converted.lon
                        });
                    }
                });

                // ì¤‘ë³µ ì œê±°ëœ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                var transformedData = Array.from(uniqueDataMap.values());
                console.log("ì¤‘ë³µ ì œê±°ëœ ë°ì´í„° ê°œìˆ˜:", transformedData.length);

                if (map) {
                    for (var i = 0; i < transformedData.length; i++) {
                        (function(i) { //  **ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ (í´ë¡œì €) ì‚¬ìš©**
                            var position = new naver.maps.LatLng(transformedData[i].latitude, transformedData[i].longitude);
                            var img;
                            //if(transformedData[i].inspctRs==='ê²€ì¶œ'){
                            //    img= '/img/sally.png';
                            //}else{
                                img ='/common/images/ico_marker_1.svg'
                            //}
                            var marker = new naver.maps.Marker({
                                position: position,
                                map: map,
                                title: transformedData[i].fcltyNm,
                                icon: {
                                    content: [
                                        /*'<div class="map_marker_title" style="position: absolute; z-index: 10; top: 0; left: 0;">',
                                            '<img src="/common/images/ico_marker_1.svg" alt="ë§ˆì»¤ ì•„ì´ì½˜" style="width: 24px; height: 37px;">',
                                            '<span></span>',
                                        '</div>'*/
                                        '<div className="map_marker">',
                                        '        <div className="point_img flt_1"></div>',
                                        '<img src="' + img + '" alt="ë§ˆì»¤ ì•„ì´ì½˜" style="width: 24px; height: 37px;">',
                                        '    </div>',
                                    ].join(''),
                                    size: new naver.maps.Size(38, 58),
                                    anchor: new naver.maps.Point(19, 58),
                                },
                                draggable: false
                            });

                            var isDrinkable = transformedData[i].inspctRs === "ë¶ˆê²€ì¶œ"; // ìŒìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

                            //  **InfoWindow ë‚´ìš©ì„ ê° ë§ˆì»¤ì— ë§ê²Œ ìƒì„±**
                            var contentString = [
                                '<div class="mapPopUp" style="top:0%;left:0%;">',
                                  '    <div class="place_title">',
                                  '        <div class="flt_icon flt_1">ì•½ìˆ˜í„°</div>',
                                  '        <span class="' + (isDrinkable ? "able" : "disable") + '">' + (isDrinkable ? "ìŒìš©ê°€ëŠ¥" : "ìŒìš©ë¶ˆê°€") + '</span>',
                                  '        <a href="#!" class="btn_close" onclick="closeInfoWindow()"></a>',
                                  '    </div>',
                                  '    <div class="place_con">',
                                  '        <div class="img" style="background-image: url(\'/common/images/sample_img.jpg\');"></div>',
                                  '        <div>',
                                  '            <p class="place_name">' + transformedData[i].fcltyNm + '</p>',
                                  '            <ul class="place_info">',
                                  '                <li>ê²€ì‚¬ì¼ : <span>' + (transformedData[i].inspctDt || "ì •ë³´ ì—†ìŒ") + '</span></li>',
                                  '                <li>ì£¼ì†Œ : <span>' + transformedData[i].adres + '</span></li>',
                                  '                <li>ë‹´ë‹¹ë¶€ì„œ : <span>' + (transformedData[i].inspctEngn || "ì •ë³´ ì—†ìŒ") + '</span></li>',
                                  '                <li>ì—°ë½ì²˜ : <span>' + (transformedData[i].contact || "ì •ë³´ ì—†ìŒ") + '</span></li>',
                                  '            </ul>',
                                  '        </div>',
                                  '    </div>',
                                  '</div>'
                            ].join('');


                            var infowindow = new naver.maps.InfoWindow({
                                content: contentString,
                                backgroundColor: null,
                                borderColor: null,
                                borderWidth: null,
                                disableAnchor: true
                            });

                            // **ê° ë§ˆì»¤ì— ê°œë³„ì ì¸ InfoWindow ì´ë²¤íŠ¸ ì¶”ê°€**
                            naver.maps.Event.addListener(marker, "click", function () {
                                if (infowindow.getMap()) {
                                    console.log('close')
                                    infowindow.close();
                                } else {
                                    console.log('open')
                                    infowindow.open(map, marker);
                                    currentInfoWindow= infowindow;
                                }
                            });

                            // ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                            markerList.push(marker);
                        })(i); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ (IIFE) ì ìš©
                    }
                } else {
                    console.error("ì§€ë„ ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
            }
        });


    }

    // **ë§ˆì»¤ ì œê±° í•¨ìˆ˜**
    function clearMarkers() {
        for (var i = 0; i < markerList.length; i++) {
            markerList[i].setMap(null);
        }
        markerList = []; // ë°°ì—´ ì´ˆê¸°í™”
    }

    var activeLayers = {}; // í˜„ì¬ í™œì„±í™”ëœ ë ˆì´ì–´ë¥¼ ì¶”ì í•  ê°ì²´

    function drawWATERFCLTSLayer(markerNm) {
        // ì´ë¯¸ í•´ë‹¹ ë ˆì´ì–´ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ê³  ì¢…ë£Œ
        if (activeLayers[markerNm]) {
            removeLayer(markerNm);
            return;
        }

        var img;
        var hydrKndType = 'ë¶„ìˆ˜';

        switch (markerNm) {
            case "FOUNTAIN":
                img = '/common/images/ico_marker_2.svg';
                hydrKndType = "ë¶„ìˆ˜";
                break;
            case "MOORAGE":
                img = '/common/images/ico_marker_3.svg';
                hydrKndType = "ê³„ë¥˜ì‹œì„¤";
                break;
            case "WATERFLOW":
                img = '/common/images/ico_marker_4.svg';
                hydrKndType = "ë²½ì²œ";
                break;
            case "COMBINATION":
                img = '/common/images/ico_marker_5.svg';
                hydrKndType = "ì¡°í•©ë†€ì´ëŒ€";
                break;
        }

        var param = 'ctzn_selectDrawMapData_' + hydrKndType + '.json';

        $.ajax({
            url: url + path + param,  //https://water.gg.go.kr/ctzn/selectDrawMapData.do?sigunNm=all&hydrKndType=%EB%B6%84%EC%88%98
            dataType: 'json',
            data: { sigunNm: '' },
            success: function (geojson) {
                console.log("ì›ë³¸ ë°ì´í„°:", geojson.list);
                var transformedData = geojson.list.map(item => {
                    var converted = webMercatorToWGS84(parseFloat(item.x), parseFloat(item.y));
                    return {
                        ...item,
                        latitude: converted.lat,
                        longitude: converted.lon
                    };
                });

                if (map) {
                    var markerList = []; // ìƒˆë¡­ê²Œ ì¶”ê°€ë  ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸

                    for (var i = 0; i < transformedData.length; i++) {
                        (function (i) {
                            var position = new naver.maps.LatLng(transformedData[i].latitude, transformedData[i].longitude);
                            var marker = new naver.maps.Marker({
                                position: position,
                                map: map,
                                title: transformedData[i].fcltyNm,
                                icon: {
                                    content: [
                                        '<div className="map_marker">',
                                        '    <div className="point_img flt_1"></div>',
                                        '<img src="' + img + '" alt="ë§ˆì»¤ ì•„ì´ì½˜" style="width: 24px; height: 37px;">',
                                        '</div>',
                                    ].join(''),
                                    size: new naver.maps.Size(38, 58),
                                    anchor: new naver.maps.Point(19, 58),
                                },
                                draggable: false
                            });

                            var contentString = [
                                '<div class="mapPopUp" style="top:0%;left:0%;">',
                                '    <div class="place_title">',
                                '        <div class="flt_icon flt_1">' + hydrKndType + '</div>',
                                '        <span class="able">' + hydrKndType + '</span>',
                                '        <a href="#!" class="btn_close" onclick="closeInfoWindow()"></a>',
                                '    </div>',
                                '    <div class="place_con">',
                                '        <div class="img" style="background-image: url(\'/common/images/sample_img.jpg\');"></div>',
                                '        <div>',
                                '            <p class="place_name">' + transformedData[i].fcltyNm + '</p>',
                                '            <ul class="place_info">',
                                '                <li>ê²€ì‚¬ì¼ : <span>' + (transformedData[i].inspctDt || "ì •ë³´ ì—†ìŒ") + '</span></li>',
                                '                <li>ì£¼ì†Œ : <span>' + transformedData[i].adres + '</span></li>',
                                '                <li>ë‹´ë‹¹ë¶€ì„œ : <span>' + (transformedData[i].inspctEngn || "ì •ë³´ ì—†ìŒ") + '</span></li>',
                                '                <li>ì—°ë½ì²˜ : <span>' + (transformedData[i].contact || "ì •ë³´ ì—†ìŒ") + '</span></li>',
                                '            </ul>',
                                '        </div>',
                                '    </div>',
                                '</div>'
                            ].join('');

                            var infowindow = new naver.maps.InfoWindow({
                                content: contentString,
                                backgroundColor: null,
                                borderColor: null,
                                borderWidth: null,
                                disableAnchor: true //ë„¤ì´ë²„ì§€ë„ ë§ˆì»¤ ë§í’ì„  ì˜µì…˜
                            });

                            naver.maps.Event.addListener(marker, "click", function () {
                                if (infowindow.getMap()) {
                                    console.log('close');
                                    infowindow.close();
                                } else {
                                    console.log('open');
                                    infowindow.open(map, marker);
                                    currentInfoWindow = infowindow;
                                }
                            });

                            markerList.push(marker); // ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                        })(i);
                    }

                    // ìƒˆë¡­ê²Œ ì¶”ê°€í•œ ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸ë¥¼ ì €ì¥
                    activeLayers[markerNm] = markerList;
                } else {
                    console.error("ì§€ë„ ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
            }
        });
    }

    // íŠ¹ì • ë ˆì´ì–´ ì‚­ì œ í•¨ìˆ˜
    function removeLayer(markerNm) {
        if (activeLayers[markerNm]) {
            activeLayers[markerNm].forEach(marker => marker.setMap(null)); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
            delete activeLayers[markerNm]; // í™œì„± ë ˆì´ì–´ ëª©ë¡ì—ì„œ ì‚­ì œ
            console.log(markerNm + " ë ˆì´ì–´ ì œê±° ì™„ë£Œ");
        }
    }

    // ì‹œ/êµ°/êµ¬ ì¤‘ì‹¬ ì¢Œí‘œ ë°ì´í„°
    var cityCoordinates = {
        "ìˆ˜ì›ì‹œ": {lat: 37.2636, lon: 127.0286},
        "ìš©ì¸ì‹œ": {lat: 37.2411, lon: 127.1775},
        "ê³ ì–‘ì‹œ": {lat: 37.6584, lon: 126.8326},
        "í™”ì„±ì‹œ": {lat: 37.1995, lon: 126.8312},
        "ì„±ë‚¨ì‹œ": {lat: 37.4200, lon: 127.1267},
        "ë¶€ì²œì‹œ": {lat: 37.5035, lon: 126.7660},
        "ë‚¨ì–‘ì£¼ì‹œ": {lat: 37.6359, lon: 127.2165},
        "ì•ˆì‚°ì‹œ": {lat: 37.3219, lon: 126.8309},
        "í‰íƒì‹œ": {lat: 36.9921, lon: 127.1126},
        "ì•ˆì–‘ì‹œ": {lat: 37.3943, lon: 126.9568},
        "ì‹œí¥ì‹œ": {lat: 37.3801, lon: 126.8022},
        "íŒŒì£¼ì‹œ": {lat: 37.7599, lon: 126.7793},
        "ê¹€í¬ì‹œ": {lat: 37.6173, lon: 126.7153},
        "ì˜ì •ë¶€ì‹œ": {lat: 37.7381, lon: 127.0338},
        "ê´‘ì£¼ì‹œ": {lat: 37.4171, lon: 127.2553},
        "í•˜ë‚¨ì‹œ": {lat: 37.5393, lon: 127.2149},
        "ê´‘ëª…ì‹œ": {lat: 37.4785, lon: 126.8643},
        "êµ°í¬ì‹œ": {lat: 37.3615, lon: 126.9356},
        "ì–‘ì£¼ì‹œ": {lat: 37.7852, lon: 127.0454},
        "ì˜¤ì‚°ì‹œ": {lat: 37.1454, lon: 127.0664},
        "ì´ì²œì‹œ": {lat: 37.2726, lon: 127.4350},
        "ì•ˆì„±ì‹œ": {lat: 37.0079, lon: 127.2796},
        "êµ¬ë¦¬ì‹œ": {lat: 37.5942, lon: 127.1294},
        "ì˜ì™•ì‹œ": {lat: 37.3446, lon: 126.9685},
        "í¬ì²œì‹œ": {lat: 37.8943, lon: 127.2000},
        "ì–‘í‰êµ°": {lat: 37.4914, lon: 127.4872},
        "ì—¬ì£¼ì‹œ": {lat: 37.2958, lon: 127.6350},
        "ë™ë‘ì²œì‹œ": {lat: 37.9032, lon: 127.0601},
        "ê³¼ì²œì‹œ": {lat: 37.4292, lon: 126.9871},
        "ê°€í‰êµ°": {lat: 37.8315, lon: 127.5097},
        "ì—°ì²œêµ°": {lat: 38.0968, lon: 127.0752}
    };

    function moveToLocation(selectedCity) {
        if (selectedCity === "all") {
            var seoulCityHall = new naver.maps.LatLng(37.5665, 126.9780); // ì„œìš¸ì‹œì²­ ì¢Œí‘œ
            map.setCenter(seoulCityHall);
            map.setZoom(10); // ì¤Œ ë ˆë²¨ 10 ì„¤ì •
            return;
        }

        var location = cityCoordinates[selectedCity];
        if (location) {
            var newCenter = new naver.maps.LatLng(location.lat, location.lon);
            map.setCenter(newCenter);
            console.log(selectedCity + "ë¡œ ì´ë™: ", location);
        } else {
            console.error("í•´ë‹¹ ì§€ì—­ ì¢Œí‘œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }


    // ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    $('.btn_location').on('click', getCurrentLocation);

    //ìƒíƒœ í•˜ì²œ
    $('#ECRIV').on('click', drowEcriv);

    //êµ­ê°€ í•˜ì²œ
    $('#RIVER_NATION').on('click', drowRiverNation);

    //ì§€ë°© í•˜ì²œ
    $('#RIVER_PROVINCE').on('click', drowRiverProvince);

    // ì•½ìˆ˜í„°
    $('#MNSP').on('click', function () {
        if (isLayerActive) {
            clearMarkers();
            $(this).closest('li').removeClass('check');
            isLayerActive = false;
        } else {
            drawMNSPLayer();
            $(this).closest('li').addClass('check');
            isLayerActive = true;
        }
    });
    //ì „ì²´ ì„ íƒ
    $('#selectAll').on('click', function () {
        if (isAllSelected) {
            // ğŸ”¹ ì „ì²´ í•´ì œ
            clearMarkers();
            drawWATERFCLTSLayer('FOUNTAIN');
            drawWATERFCLTSLayer('MOORAGE');
            drawWATERFCLTSLayer('WATERFLOW');
            drawWATERFCLTSLayer('COMBINATION');
            drowEcriv();
            drowRiverNation();
            drowRiverProvince();

            $('li').removeClass('check');
            isLayerActive = false;
            isAllSelected = false;
        } else {
            // ğŸ”¹ ì „ì²´ ì„ íƒ
            drawMNSPLayer();
            drawWATERFCLTSLayer('FOUNTAIN');
            drawWATERFCLTSLayer('MOORAGE');
            drawWATERFCLTSLayer('WATERFLOW');
            drawWATERFCLTSLayer('COMBINATION');
            drowEcriv();
            drowRiverNation();
            drowRiverProvince();

            $('li').addClass('check');
            isLayerActive = true;
            isAllSelected = true;
        }
    });


</script>
</html>