<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home Page</title>

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=ebw9oxmgrs"></script>
    <!--<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=ebw9oxmgrs&amp;submodules=panorama,geocoder,drawing,visualization"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps-panorama.js"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps-geocoder.js"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps-drawing.js"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps-visualization.js"></script>
</head>
<body>

<div id="map" style="width: 100%; height: 600px; position: relative; overflow: hidden; background: rgb(248, 249, 250);"
     tabindex="0">
    <div class="search" style="">
        <input id="address" type="text" placeholder="ê²€ìƒ‰í•  ì£¼ì†Œ" value="ë¶ˆì •ë¡œ 6">
        <input id="submit" type="button" value="ì£¼ì†Œ ê²€ìƒ‰">
    </div>


</div>
<div style="display:inline;">
    <button style="padding:10px 10px; margin:2px;" id="drawSingle" class="btn">ë‹¨ì¼ í´ë¦¬ë¼ì¸ìœ¼ë¡œ ê·¸ë¦¬ê¸°</button>
    <button style="padding:10px 10px; margin:2px;" id="drawMulti" class="btn">ë©€í‹° í´ë¦¬ë¼ì¸ìœ¼ë¡œ ê·¸ë¦¬ê¸°</button>
    <button style="padding:10px 10px; margin:2px;" id="remove" class="btn">í´ë¦¬ë¼ì¸ ì‚­ì œ</button>
</div>
<div id="map2" style="width: 100%; height: 600px; position: relative; overflow: hidden; background: rgb(248, 249, 250);" tabindex="0">

</div>

<script>
    var map = new naver.maps.Map("map", {
            center: new naver.maps.LatLng(37.5666103, 126.9783882),
            zoom: 16
        }),
        infoWindow = null;

    function initGeocoder() {
        var latlng = map.getCenter();
        var utmk = naver.maps.TransCoord.fromLatLngToUTMK(latlng); // ìœ„/ê²½ë„ -> UTMK
        var tm128 = naver.maps.TransCoord.fromUTMKToTM128(utmk);   // UTMK -> TM128
        var naverCoord = naver.maps.TransCoord.fromTM128ToNaver(tm128); // TM128 -> NAVER

        infoWindow = new naver.maps.InfoWindow({
            content: ''
        });

        map.addListener('click', function(e) {
            var latlng = e.coord,
                utmk = naver.maps.TransCoord.fromLatLngToUTMK(latlng),
                tm128 = naver.maps.TransCoord.fromUTMKToTM128(utmk),
                naverCoord = naver.maps.TransCoord.fromTM128ToNaver(tm128);

            utmk.x = parseFloat(utmk.x.toFixed(1));
            utmk.y = parseFloat(utmk.y.toFixed(1));

            infoWindow.setContent([
                '<div style="padding:10px;width:380px;font-size:14px;line-height:20px;">',
                '<strong>LatLng</strong> : '+ 'ì¢Œ í´ë¦­ ì§€ì  ìœ„/ê²½ë„ ì¢Œí‘œ: '+ latlng+'<br />',

                '</div>'
            ].join(''));

            infoWindow.open(map, latlng);
            console.log('LatLng: ' + latlng.toString());
            //console.log('UTMK: ' + utmk.toString());
            //console.log('TM128: ' + tm128.toString());
            //console.log('NAVER: ' + naverCoord.toString());
        });
    }

    naver.maps.onJSContentLoaded = initGeocoder;

    var HOME_PATH = window.HOME_PATH || '.';
    var cityhall = new naver.maps.LatLng(37.5666805, 126.9784147),
        map = new naver.maps.Map('map', {
            center: cityhall,
            zoom: 15
        }),
        marker = new naver.maps.Marker({
            map: map,
            position: cityhall
        });

    var contentString = [
            '<div class="iw_inner">',
            '   <h3>ì„œìš¸íŠ¹ë³„ì‹œì²­</h3>',
            '   <p>ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ íƒœí‰ë¡œ1ê°€ 31 | ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110 ì„œìš¸íŠ¹ë³„ì‹œì²­<br />',
            '       <img src="' +'/img/sally.png" width="55" height="55" alt="ì„œìš¸ì‹œì²­" class="thumb" /><br />',
            '       02-120 | ê³µê³µ,ì‚¬íšŒê¸°ê´€ &gt; íŠ¹ë³„,ê´‘ì—­ì‹œì²­<br />',
            '       <a href="http://www.seoul.go.kr" target="_blank">www.seoul.go.kr/</a>',
            '   </p>',
            '</div>'
        ].join('');

    var infowindow = new naver.maps.InfoWindow({
        content: contentString,
        maxWidth: 500,
        backgroundColor: "#eee",
        borderColor: "#2db400",
        borderWidth: 3,
        anchorSize: new naver.maps.Size(30, 30),
        anchorSkew: true,
        anchorColor: "#eee",
        pixelOffset: new naver.maps.Point(20, -20)
    });

    naver.maps.Event.addListener(marker, "click", function(e) {
        if (infowindow.getMap()) {
            infowindow.close();
        } else {
            infowindow.open(map, marker);
        }
    });
</script>
<script>
    // ì„œìš¸ -> ë¶€ì‚° ê¸¸ì°¾ê¸°
    var HOME_PATH = window.HOME_PATH || '.';
    var bicycleRouteUrl = 'http://localhost/data/polyline_route.json'


    console.log(bicycleRouteUrl)

</script>
<script id="code">
    var cacheSteps,
        polyLines,
        polylineOptions = {
            fillColor: '#E16E79',
            fillOpacity: 1,
            strokeColor: '#E16E79',
            strokeOpacity: 1,
            strokeWeight: 3,
        };

    var map2 = new naver.maps.Map('map2', {
        center: new naver.maps.LatLng(36.3835833, 128.0344242),
        zoom: 6,
        zoomControl: true,
        zoomControlOptions: {
            style: naver.maps.ZoomControlStyle.SMALL,
            position: naver.maps.Position.RIGHT_CENTER
        }
    });

    function loadData(localCompleteCallback) {
        console.time('loadData');
        console.log('loadData');
        console.log('bicycleRouteUrl: '+ bicycleRouteUrl);
        console.log('@@localCompleteCallback: '+ localCompleteCallback);
        $.get(bicycleRouteUrl, localCompleteCallback, 'json').fail(loadFail);
    }

    function draw(result, drawMethod) {
        // ë°ì´í„° êµ¬ì¡°ë¥¼ ì²´í¬
        if (!Array.isArray(result)) {
            console.error("âŒ resultê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤!", result);
            return;
        }

        try {
            // ğŸš¨ ê¸°ì¡´ ì½”ë“œì—ì„œ result.routes[0].legs[0].stepsë¥¼ ì‚¬ìš©í–ˆëŠ”ë°, JSON êµ¬ì¡°ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì•¼ í•¨
            if (!result[0].path) {
                console.error("âŒ ë°ì´í„° êµ¬ì¡° ì˜¤ë¥˜! path ì†ì„±ì´ ì—†ìŒ:", result[0]);
                return;
            }

            polyLines = drawMethod(result);  // ì—¬ê¸°ì„œ resultë¥¼ ì§ì ‘ ì „ë‹¬
        } catch (error) {
            console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }


    function loadFail(error) {
        console.log('loadFail', error);
    }

    function drawSingle() {
        console.log('1');

        if (!map2) return;
        remove();
        console.log('cacheSteps: '+cacheSteps);
        console.log('polyLines: '+polyLines);
        cacheSteps ? polyLines = drawSinglePolyline(cacheSteps) : loadData(function (result) {
            draw(result, drawSinglePolyline);
        });
    }

    function drawMulti() {
        if (!map2) return;
        remove();
        cacheSteps ? polyLines = drawMultiPolyline(cacheSteps) : loadData(function (result) {
            draw(result, drawMultiPolyline);
        });
    }

    function filterAndCacheSteps(steps) {
        console.time('filterAndCacheSteps');
        console.log('filterAndCacheSteps');

        if (!Array.isArray(steps)) {
            console.error("âŒ stepsê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤!", steps);
            return [];
        }

        cacheSteps = steps.filter(step => !!step.path);

        console.log(`âœ… cacheSteps ê¸¸ì´: ${cacheSteps.length}`);
        console.log("ğŸ§ ì²« ë²ˆì§¸ í•­ëª©:", cacheSteps[0]);
        console.log("ğŸ“Œ path ê°’ë§Œ ì¶œë ¥:", cacheSteps.map(step => step.path));
        console.log("ğŸ“ JSON í˜•íƒœë¡œ ì „ì²´ ì¶œë ¥:", JSON.stringify(cacheSteps, null, 2));

        console.timeEnd('filterAndCacheSteps');
        return cacheSteps;
    }


    function drawSinglePolyline(steps) {
        if (!Array.isArray(steps)) {
            console.error("âŒ stepsê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤!", steps);
            return [];
        }

        console.log("ğŸ“Œ steps ë°ì´í„° í™•ì¸:", steps);

        console.time('drawSinglePolyline');
        var allPaths = [];

        steps.forEach(step => {
            if (!step.path) {
                console.warn("âš ï¸ pathê°€ ì—†ëŠ” ë°ì´í„°:", step);
                return;
            }
            allPaths = allPaths.concat(getPaths(step.path));
        });

        polyLines = [createPolyline(allPaths)];
        console.timeEnd('drawSinglePolyline');

        return polyLines;
    }


    function drawMultiPolyline(steps) {
        if (!steps) return;
        console.time('drawMultiPolyline');
        var polyLines = filterAndCacheSteps(steps).map(step => createPolyline(getPaths(step.path)));
        console.timeEnd('drawMultiPolyline');
        return polyLines;
    }

    function getPaths(path) {
        var paths = [],
            steps = path.split(' ');
        steps.map(step => {
            var splitStep = step.split(',').map(point => parseFloat(point)),
                latLng = new naver.maps.LatLng(splitStep[1], splitStep[0]);
            paths.push(latLng);
        });
        return paths;
    }

    function createPolyline(paths) {
        var polyline = new naver.maps.Polyline({
            map2: map2,
            path: paths,
            ...polylineOptions,
        });
        return polyline;
    }

    function remove() {
        if (!polyLines) return;
        polyLines.map(polyLine => polyLine.setMap(null));
        polyLines.length = 0;
        polyLines = [];
    }

    $('#drawSingle').on('click', drawSingle);
    $('#drawMulti').on('click', drawMulti);
    $('#remove').on('click', remove);

</script>
</body>
</html>